PROC SORT DATA=PREPROC1.ALLDATA OUT=ALLDATA;
  BY DSN;/**/
OPTIONS FMTSEARCH=(FMTLIB.FORMATS) PAGESIZE=80 SORTWKNO=3;
DATA _NULL_;
  LENGTH DFILE MFILE $7;
  SET ALLDATA(OBS=1);
  CALL SYMPUT('VOLSIR',VOLSER);
  VOLSER = TRANSLATE(VOLSER,'S','$');
    DFILE = TRIM(SYSID)||'DSN';
    MFILE = TRIM(SYSID)||'MEM';
    PUT DFILE= MFILE=;
    CALL SYMPUT('DSNFILE',DFILE);
    CALL SYMPUT('MEMFILE',MFILE);
    CALL SYMPUT('VOLSR',VOLSER);
RUN;

PROC FORMAT;
  VALUE $LIB
    '1' = 'DLIB'
    '2' = 'TLIB'
    '3' = 'XLIB'
    '4' = 'NLIB'
    '6' = 'SMPE';

  VALUE $EDIT
    '  ' = 'OK'
    'CL' = 'OK'
    'CN' = 'OK'
    'DO' = 'OK'
    'EX' = 'OK'
    'FO' = 'OK'
    'HE' = 'OK'
    'IN' = 'OK'
    'JS' = 'OK'
    'LO' = 'OK'
    'LL' = 'OK'
    'MA' = 'OK'
    'MS' = 'OK'
    'NL' = 'OK'
    'OB' = 'OK'
    'PA' = 'OK'
    'PN' = 'OK'
    'PR' = 'OK'
    'RL' = 'OK'
    'SA' = 'OK'
    'SK' = 'OK'
    'SR' = 'OK'
    'TB' = 'OK'
   OTHER = 'ER';

  VALUE $TYPE
   'CL' = 'CLIST'
   'CN' = 'CONTROL CARD'
   'DO' = 'DOCUMENTATION'
   'EX' = 'REXX EXEC'
   'FO' = 'FONTS - AFP'
   'HE' = 'HELP'
   'IN' = 'INSTALL'
   'JS' = 'JOBSTREAM'
   'LO' = 'LINKED OBJECT'
   'LL' = 'LOAD'
   'MA' = 'MACRO'
   'MS' = 'MESSAGE'
   'NL' = 'NON-LL LMOD'
   'OB' = 'OBJECT'
   'PA' = 'PARMLIB'
   'PN' = 'PANEL'
   'PR' = 'PROCLIB'
   'RL' = 'RPLLIST ONLY'
   'SA' = 'SAMPLE'
   'SK' = 'SKELETON'
   'SR' = 'SOURCE'
   'TB' = 'TABLE'
   '  ' = 'UNKNOWN'
  OTHER = 'ERROR';

  VALUE $INDX
    'A'  = ' 1'
    'B'  = ' 2'
    'C'  = ' 3'
    'D'  = ' 4'
    'E'  = ' 5'
    'F'  = ' 6'
    'G'  = ' 7'
    'H'  = ' 8'
    'I'  = ' 9'
    'J'  = '10'
    'K'  = '11'
    'L'  = '12'
    'M'  = '13'
    'N'  = '14'
    'O'  = '15'
    'P'  = '16'
    'Q'  = '17'
    'R'  = '18'
    'S'  = '19'
    'T'  = '20'
    'U'  = '21'
    'V'  = '22'
    'W'  = '23'
    'X'  = '24'
    'Y'  = '25'
    'Z'  = '26';

  VALUE $UNIT
    'A' = ' ABS'
    'B' = ' BLK'
    'C' = ' CYL'
    'T' = ' TRK'
    ;

  VALUE $EXCLD
    'O' = 'OBSOLETE OR UNUSED       '
    'F' = 'FUTURE LIBRARY           '
    'P' = 'PARTIAL-NON MATCHED NAMES'
    ;



DATA DLIB;
  TITLE1 'DATASET INVENTORY SYSTEM -- DLIB CONTROL CARD EDIT';
  TITLE2 ' VOLUME SERIAL -- '&VOLSIR ;
  FILE REPORTA;
  INFILE DLIB;
  INPUT @1 TYPE $2. @4 FMID $7. @15 DSN $44.;
  CLASS = 'DLIB';
  ERROR = PUT(TYPE,$EDIT.);
  IF ERROR = 'ER' THEN DO;
    PUT TYPE= DSN=;
    DELETE;
    END;

DATA TLIB;
  TITLE1 'DATASET INVENTORY SYSTEM -- TLIB CONTROL CARD EDIT';
  TITLE2 ' VOLUME SERIAL -- '&VOLSIR ;
  FILE REPORTA;
  INFILE TLIB;
  INPUT @1 TYPE $2. @4 FMID $7.
        @12 EXCLUDE $1. @13 RUN $1. @15 DSN $44.;
  CLASS = 'TLIB';
  ERROR = PUT(TYPE,$EDIT.);
  IF ERROR = 'ER' THEN DO;
    PUT TYPE= DSN=;
    DELETE;
    END;

OPTIONS PAGENO=1;
PROC PRINTTO PRINT=TLIBRPT;
PROC PRINT DATA=TLIB UNIFORM NOOBS LABEL;
  FORMAT TYPE $TYPE.
         FMID $FMID.
      EXCLUDE $EXCLD.
          DSN $40.;
  LABEL  FMID='PRODUCT DESCRIPTION'
      EXCLUDE='REASON FOR EXCLUSION';
  VAR DSN TYPE FMID EXCLUDE;
  TITLE 'DATASET INVENTORY SYSTEM -- TLIB CONTROL CARD REPORT';
PROC PRINTTO ;

OPTIONS PAGENO=1;
PROC PRINTTO PRINT=DLIBRPT;
PROC PRINT DATA=DLIB UNIFORM NOOBS LABEL;
  FORMAT TYPE $TYPE.
         FMID $FMID.
          DSN $40.;
  LABEL  FMID='PRODUCT DESCRIPTION'
  VAR DSN TYPE FMID ;
  TITLE  'DATASET INVENTORY SYSTEM -- DLIB CONTROL CARD REPORT';
PROC PRINTTO ;

DATA SMPE;
  INFILE SMPE;
  INPUT @1 TYPE $2. @4 FMID $7. @15 DSN $44.;
  CLASS = 'SMPE';
  ERROR = PUT(TYPE,$EDIT.);
  IF ERROR = 'ER' THEN DO;
    PUT TYPE= DSN=;
    DELETE;
    END;

DATA XLIB;
  INFILE XLIB;
  INPUT @1 TYPE $2. @4 FMID $7. @15 DSN $44.;
  CLASS = 'XLIB';
  ERROR = PUT(TYPE,$EDIT.);
  IF ERROR = 'ER' THEN DO;
    PUT TYPE= DSN=;
    DELETE;
    END;

OPTIONS PAGENO=1;
PROC PRINTTO PRINT=XLIBRPT;
PROC PRINT DATA=XLIB UNIFORM NOOBS LABEL;
  FORMAT TYPE $TYPE.
         FMID $FMID.
          DSN $40.;
  LABEL  FMID='PRODUCT DESCRIPTION'
  VAR DSN TYPE FMID ;
  TITLE  'DATASET INVENTORY SYSTEM -- XLIB CONTROL CARD REPORT';
PROC PRINTTO ;

DATA CNTLCRDS;
  SET
      DLIB
      TLIB
      SMPE
      XLIB;

PROC SORT DATA=CNTLCRDS;
  BY DSN;

DATA DSNTEMP1(KEEP=SYSID DSN VOLSER DSORG RECFM BLKSIZE LRECL DDATE
                   TYPE CLASS EXTENTS SPACE DSTYPE DSNTYPE FMID)
     DSNTEMP2(KEEP=DSN MEMNO)
     &MEMFILE..&VOLSR(KEEP=MEMTYPE SYSID DSN VOLSER MEMBER DE DATE UID
                     HASH TYPE CLASS FMID DSNTYPE DDATE EXCLUDE RUN
                     COMPRESS=YES);
  MERGE ALLDATA (IN=PROC1IN)
        CNTLCRDS         (IN=CNTRLIN);
  BY DSN;

  IF PROC1IN = 1 AND CNTRLIN = 0 AND DSORG='PO' THEN
    PUT 'CONTROL CARD REQUIRED FOR DSN ' DSN;
  IF PROC1IN = 0 THEN DELETE;

  IF MEMTYPE = ' ' THEN DO;
    OUTPUT DSNTEMP1;
    MEMNO = 0;
    END;
  ELSE DO;
    OUTPUT &MEMFILE..&VOLSR;
    MEMNO = MEMNO + 1; RETAIN MEMNO;
    END;
  IF LAST.DSN THEN OUTPUT DSNTEMP2;
RUN;

  PROC APPEND BASE=&MEMFILE..ALLDATA DATA=&MEMFILE..&VOLSR;
RUN;

DATA CNTLDSN;
  INFILE DSNIN;
  INPUT @1 DSN $44.;
  IF SUBSTR(DSN,1,6)='TOTALS' THEN DELETE;

PROC SORT DATA=CNTLDSN;
  BY DSN;

DATA &DSNFILE..&VOLSR;
  MERGE DSNTEMP1 (IN=DSN1IN)
        DSNTEMP2 (IN=DSN2IN)
        CNTLDSN  (IN=CNTLIN);
    BY DSN;
  FILE PRINT;
  IF CNTLIN = 0 THEN DO;
    PUT 'NO CONTROL CARD FOR ' DSN $40. 'DATASET WILL BE DELETED.';
    DELETE;
    END;
  IF DSN1IN = 0 THEN DO;
    PUT 'CONTROL CARD FOR ' DSN $40. 'NOT REQUIRED.  '
       "DATASET IS NOT ON &VOLSIR OR HAS BEEN PREVIOUSLY EXCLUDED.";
    DELETE;
    END;

  PROC APPEND BASE=&DSNFILE..ALLDATA DATA=&DSNFILE..&VOLSR;
RUN;

PROC PRINTTO PRINT=DSNRPT;
PROC CONTENTS DATA=&DSNFILE..&VOLSR;
PROC CONTENTS DATA=&MEMFILE..&VOLSR;
PROC PRINT DATA=&DSNFILE..&VOLSR;
  FORMAT DDATE DATE7.;
  TITLE1 'DATASET INVENTORY SYSTEM -- VTOC DSN REPORT BY VOLUME';
  TITLE2 ' VOLUME SERIAL -- '&VOLSIR ;
PROC PRINTTO;
